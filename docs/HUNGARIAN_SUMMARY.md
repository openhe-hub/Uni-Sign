# Hungarian Loss for CSLR - å®ç°æ€»ç»“

## ğŸ“¦ æœ¬æ¬¡æ›´æ–°å†…å®¹

ä¸ºCSLRï¼ˆContinuous Sign Language Recognitionï¼‰ä»»åŠ¡æ·»åŠ äº†åŒˆç‰™åˆ©æŸå¤±æ”¯æŒï¼Œç”¨äºå¤„ç†glossæ ‡æ³¨é¡ºåºä¸è§†é¢‘é¡ºåºä¸ä¸€è‡´çš„é—®é¢˜ã€‚

---

## ğŸ“ æ–°å¢/ä¿®æ”¹æ–‡ä»¶æ¸…å•

### âœ¨ æ–°å¢æ–‡ä»¶

#### æ ¸å¿ƒå®ç°
- **`hungarian_loss.py`** - åŒˆç‰™åˆ©æŸå¤±å®ç°
  - `HungarianMatcher`: ä½¿ç”¨åŒˆç‰™åˆ©ç®—æ³•è¿›è¡Œæœ€ä¼˜glossåŒ¹é…
  - `HungarianLoss`: åŸºäºåŒ¹é…ç»“æœè®¡ç®—æŸå¤±
  - `compute_set_based_metrics`: è®¡ç®—æ— åºé›†åˆçš„è¯„ä¼°æŒ‡æ ‡

#### è®­ç»ƒè„šæœ¬
- **`script/train_cslr_baseline.sh`** - åŸºçº¿ï¼ˆçº¯CEæŸå¤±ï¼‰
- **`script/train_cslr_hungarian_0.3.sh`** - è½»é‡ç‰ˆï¼ˆ30%åŒˆç‰™åˆ©ï¼‰
- **`script/train_cslr_hungarian_0.5.sh`** - å¹³è¡¡ç‰ˆï¼ˆ50%åŒˆç‰™åˆ©ï¼‰
- **`script/train_cslr_hungarian_0.7.sh`** - é‡é‡ç‰ˆï¼ˆ70%åŒˆç‰™åˆ©ï¼‰

#### æ–‡æ¡£
- **`docs/HUNGARIAN_LOSS_GUIDE.md`** - è¯¦ç»†ä½¿ç”¨æ–‡æ¡£
- **`docs/QUICKSTART_HUNGARIAN.md`** - å¿«é€Ÿå¼€å§‹æŒ‡å—
- **`docs/HUNGARIAN_SUMMARY.md`** - æœ¬æ–‡ä»¶

### ğŸ”§ ä¿®æ”¹æ–‡ä»¶

1. **`models.py`**
   - ç¬¬142-155è¡Œï¼šåˆå§‹åŒ–åŒˆç‰™åˆ©æŸå¤±
   - ç¬¬320-336è¡Œï¼šæ··åˆæŸå¤±è®¡ç®—

2. **`utils.py`**
   - ç¬¬535-538è¡Œï¼šæ–°å¢å‘½ä»¤è¡Œå‚æ•°
     ```python
     --use_hungarian      # å¯ç”¨åŒˆç‰™åˆ©æŸå¤±
     --hungarian_weight   # è®¾ç½®æƒé‡ï¼ˆ0.0-1.0ï¼‰
     ```

3. **`download_scripts/download_CSL_News.py`**
   - ç¬¬51è¡Œï¼šä¿®å¤poseæ•°æ®è§£å‹è·¯å¾„bug

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### åŸºç¡€ç”¨æ³•

```bash
# 1. åŸºçº¿å®éªŒ
./script/train_cslr_baseline.sh

# 2. åŒˆç‰™åˆ©æŸå¤±å®éªŒï¼ˆæ¨èå…ˆç”¨0.3ï¼‰
./script/train_cslr_hungarian_0.3.sh

# 3. å¯¹æ¯”ç»“æœ
grep "Min WER" out/cslr_baseline/log.txt
grep "Min WER" out/cslr_hungarian_0.3/log.txt
```

### è‡ªå®šä¹‰è®­ç»ƒ

```bash
deepspeed fine_tuning.py \
  --task CSLR \
  --dataset CSL_Daily \
  --finetune out/stage1_pretraining/best_checkpoint.pth \
  --use_hungarian \
  --hungarian_weight 0.4  # è‡ªå®šä¹‰æƒé‡
```

---

## ğŸ¯ æŠ€æœ¯åŸç†

### é—®é¢˜èƒŒæ™¯

åœ¨CSLRä»»åŠ¡ä¸­ï¼š
- Glossæ ‡æ³¨é¡ºåºå¯èƒ½ä¸è§†é¢‘ä¸­æ‰‹è¯­é¡ºåºä¸ä¸€è‡´
- ä¼ ç»ŸCEæŸå¤±ä¸¥æ ¼è¦æ±‚ä½ç½®å¯¹åº”ï¼Œå¯¼è‡´é”™è¯¯æƒ©ç½š

### è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨**åŒˆç‰™åˆ©ç®—æ³•**æ‰¾åˆ°é¢„æµ‹å’Œç›®æ ‡ä¹‹é—´çš„æœ€ä¼˜åŒ¹é…ï¼š

```
æ ‡æ³¨: [ä½ , æˆ‘, å¥½]
é¢„æµ‹: [æˆ‘, å¥½, ä½ ]

ä¼ ç»ŸCE: 3ä¸ªä½ç½®éƒ½é”™ â†’ é«˜æŸå¤±
åŒˆç‰™åˆ©:  æ‰¾åˆ°æœ€ä¼˜åŒ¹é… â†’ ä½æŸå¤±
```

### æŸå¤±å‡½æ•°

```python
Total_Loss = (1 - Î±) Ã— CE_Loss + Î± Ã— Hungarian_Loss
```

å…¶ä¸­ Î± æ˜¯ `hungarian_weight` å‚æ•°ã€‚

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¼˜ç‚¹
- âœ… WERå¯èƒ½é™ä½2-5%
- âœ… å¯¹glossé¡ºåºå˜åŒ–æ›´é²æ£’
- âœ… å‡å°‘æ ‡æ³¨é¡ºåºä¸ä¸€è‡´å¯¼è‡´çš„è¯¯å·®

### æ½œåœ¨é—®é¢˜
- âš ï¸ è®­ç»ƒæ—¶é—´å¢åŠ çº¦10-15%
- âš ï¸ éœ€è¦è°ƒå‚æ‰¾æœ€ä¼˜æƒé‡
- âš ï¸ å¦‚æœé¡ºåºæœ¬èº«é‡è¦ï¼Œå¯èƒ½æŸå¤±é¡ºåºä¿¡æ¯

---

## ğŸ“ å®éªŒå»ºè®®

### å¯¹æ¯”å®éªŒæ–¹æ¡ˆ

| å®éªŒ | Hungarianæƒé‡ | è¯´æ˜ |
|------|--------------|------|
| Baseline | 0.0 | çº¯CEæŸå¤±ï¼Œä½œä¸ºå¯¹æ¯”åŸºå‡† |
| Light | 0.3 | è½»é‡ç‰ˆï¼Œåˆæ­¥éªŒè¯æ•ˆæœ |
| Medium | 0.5 | å¹³è¡¡ç‰ˆï¼ŒCEå’ŒHungarianå„åŠ |
| Heavy | 0.7 | é‡é‡ç‰ˆï¼Œå¼ºè°ƒå†…å®¹åŒ¹é… |

### å…³é”®æŒ‡æ ‡

ä¸»è¦å…³æ³¨ **WERï¼ˆWord Error Rateï¼‰**ï¼Œè¶Šä½è¶Šå¥½ï¼š
```bash
grep "Min WER" out/cslr_*/log.txt
```

---

## ğŸ› ï¸ ä¾èµ–è¦æ±‚

### PythonåŒ…
- âœ… torch (å·²æœ‰)
- âœ… scipy (éœ€è¦å®‰è£…)

å®‰è£…å‘½ä»¤ï¼š
```bash
pip install scipy
```

### æ•°æ®é›†
- âœ… CSL_Dailyï¼ˆå”¯ä¸€æœ‰glossæ ‡æ³¨çš„æ•°æ®é›†ï¼‰
- âœ… Stage 1é¢„è®­ç»ƒæ¨¡å‹

---

## ğŸ“– æ–‡æ¡£ç´¢å¼•

- **è¯¦ç»†ä½¿ç”¨æ–‡æ¡£**: `docs/HUNGARIAN_LOSS_GUIDE.md`
  - å®Œæ•´åŸç†è¯´æ˜
  - è¯¦ç»†ä½¿ç”¨æ–¹æ³•
  - è°ƒè¯•ä¸ä¼˜åŒ–å»ºè®®

- **å¿«é€Ÿå¼€å§‹**: `docs/QUICKSTART_HUNGARIAN.md`
  - 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹
  - å¸¸ç”¨å‘½ä»¤
  - å¸¸è§é”™è¯¯è§£å†³

- **æœ¬æ–‡ä»¶**: `docs/HUNGARIAN_SUMMARY.md`
  - å¿«é€Ÿæ¦‚è§ˆ
  - æ–‡ä»¶æ¸…å•

---

## ğŸ” ä»£ç ä½ç½®é€ŸæŸ¥

### æ ¸å¿ƒé€»è¾‘
```python
# hungarian_loss.py
HungarianMatcher.forward()      # ç¬¬31è¡Œï¼šåŒˆç‰™åˆ©åŒ¹é…
HungarianLoss.forward()         # ç¬¬163è¡Œï¼šæŸå¤±è®¡ç®—

# models.py
Uni_Sign.__init__()             # ç¬¬142è¡Œï¼šåˆå§‹åŒ–
Uni_Sign.forward()              # ç¬¬320è¡Œï¼šæ··åˆæŸå¤±
```

### å‘½ä»¤è¡Œå‚æ•°
```python
# utils.py
get_args_parser()               # ç¬¬535è¡Œ
```

---

## ğŸ“ å‚è€ƒèµ„æ–™

- **DETRè®ºæ–‡**: End-to-End Object Detection with Transformers
  - é¦–æ¬¡å°†åŒˆç‰™åˆ©æŸå¤±ç”¨äºæ·±åº¦å­¦ä¹ 

- **Hungarian Algorithm**:
  - O(nÂ³)å¤æ‚åº¦çš„æœ€ä¼˜äºŒåˆ†å›¾åŒ¹é…ç®—æ³•
  - ä½¿ç”¨scipyå®ç°

---

## ğŸ’¡ ä¸‹ä¸€æ­¥å·¥ä½œ

å¦‚æœåŒˆç‰™åˆ©æŸå¤±æ•ˆæœå¥½ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **åŠ¨æ€æƒé‡**: è®­ç»ƒè¿‡ç¨‹ä¸­é€æ¸å¢åŠ Hungarianæƒé‡
2. **ç»“åˆCTC**: ä¸‰è€…ç»“åˆ CE + Hungarian + CTC
3. **æ³¨æ„åŠ›æœºåˆ¶**: Gloss-aware attention
4. **æ•°æ®å¢å¼º**: éšæœºæ‰“ä¹±glossé¡ºåº

---

## âœ… æ£€æŸ¥æ¸…å•

ä¸Šä¼ åˆ°æœåŠ¡å™¨å‰ç¡®è®¤ï¼š

- [x] hungarian_loss.py å·²åˆ›å»º
- [x] models.py å·²ä¿®æ”¹
- [x] utils.py å·²ä¿®æ”¹
- [x] è®­ç»ƒè„šæœ¬å·²åˆ›å»ºï¼ˆ4ä¸ªï¼‰
- [x] æ–‡æ¡£å·²å®Œæˆ
- [x] download_CSL_News.py bugå·²ä¿®å¤

---

## ğŸ“ é—®é¢˜åé¦ˆ

é‡åˆ°é—®é¢˜æ—¶æ£€æŸ¥ï¼š
1. æ—¥å¿—æ–‡ä»¶ï¼š`out/cslr_*/log.txt`
2. scipyæ˜¯å¦å®‰è£…ï¼š`python -c "import scipy; print('OK')"`
3. æ•°æ®é›†æ˜¯å¦å®Œæ•´ï¼š`ls dataset/CSL_Daily/pose_format/ | wc -l`

---

**æ›´æ–°æ—¶é—´**: 2025-12-27
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œå¾…æœåŠ¡å™¨æµ‹è¯•

---

ç¥å®éªŒé¡ºåˆ©ï¼ğŸš€
