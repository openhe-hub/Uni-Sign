# CSLRä»»åŠ¡ - åŒˆç‰™åˆ©æŸå¤±å®ç°æ–‡æ¡£

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨Uni-Signé¡¹ç›®ä¸­ä½¿ç”¨åŒˆç‰™åˆ©æŸå¤±ï¼ˆHungarian Lossï¼‰æ¥ä¼˜åŒ–CSLRï¼ˆContinuous Sign Language Recognitionï¼‰ä»»åŠ¡ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦åŒˆç‰™åˆ©æŸå¤±ï¼Ÿ

åœ¨CSLRä»»åŠ¡ä¸­ï¼Œglossæ ‡æ³¨çš„é¡ºåºå¯èƒ½ä¸è§†é¢‘ä¸­å®é™…æ‰‹è¯­çš„é¡ºåºä¸å®Œå…¨ä¸€è‡´ã€‚ä¼ ç»Ÿçš„äº¤å‰ç†µæŸå¤±ï¼ˆCross-Entropy Lossï¼‰å¯¹ä½ç½®éå¸¸æ•æ„Ÿï¼Œä¼šå¼ºåˆ¶è¦æ±‚æ¯ä¸ªä½ç½®çš„é¢„æµ‹ä¸æ ‡æ³¨ä¸¥æ ¼å¯¹åº”ã€‚åŒˆç‰™åˆ©æŸå¤±é€šè¿‡æœ€ä¼˜äºŒåˆ†å›¾åŒ¹é…ï¼Œå…è®¸æ›´çµæ´»çš„glossåŒ¹é…ï¼Œå‡å°‘ä½ç½®åå·®çš„å½±å“ã€‚

### åŒˆç‰™åˆ©æŸå¤±åŸç†

```
ä¼ ç»ŸCEæŸå¤±:
ä½ç½®1: é¢„æµ‹="ä½ " vs æ ‡æ³¨="æˆ‘"  âœ— (é”™è¯¯)
ä½ç½®2: é¢„æµ‹="æˆ‘" vs æ ‡æ³¨="ä½ "  âœ— (é”™è¯¯)
WER: 100%

åŒˆç‰™åˆ©æŸå¤±:
ä½¿ç”¨åŒˆç‰™åˆ©ç®—æ³•æ‰¾åˆ°æœ€ä¼˜åŒ¹é…:
é¢„æµ‹="ä½ " â†” æ ‡æ³¨="ä½ "  âœ“
é¢„æµ‹="æˆ‘" â†” æ ‡æ³¨="æˆ‘"  âœ“
WER: 0%
```

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ€»ç»“

### æ–°å¢æ–‡ä»¶
1. **`hungarian_loss.py`** - åŒˆç‰™åˆ©æŸå¤±å®ç°
2. **`script/train_cslr_baseline.sh`** - åŸºçº¿è®­ç»ƒè„šæœ¬ï¼ˆä¸ä½¿ç”¨åŒˆç‰™åˆ©æŸå¤±ï¼‰
3. **`script/train_cslr_hungarian_0.3.sh`** - è½»é‡åŒˆç‰™åˆ©æŸå¤±ï¼ˆ30%æƒé‡ï¼‰
4. **`script/train_cslr_hungarian_0.5.sh`** - å¹³è¡¡åŒˆç‰™åˆ©æŸå¤±ï¼ˆ50%æƒé‡ï¼‰
5. **`script/train_cslr_hungarian_0.7.sh`** - é‡é‡åŒˆç‰™åˆ©æŸå¤±ï¼ˆ70%æƒé‡ï¼‰

### ä¿®æ”¹æ–‡ä»¶
1. **`models.py`**
   - ç¬¬142-155è¡Œï¼šåˆå§‹åŒ–åŒˆç‰™åˆ©æŸå¤±æ¨¡å—
   - ç¬¬320-336è¡Œï¼šæ··åˆæŸå¤±è®¡ç®—

2. **`utils.py`**
   - ç¬¬535-538è¡Œï¼šæ–°å¢å‘½ä»¤è¡Œå‚æ•°
     - `--use_hungarian`: å¯ç”¨åŒˆç‰™åˆ©æŸå¤±
     - `--hungarian_weight`: è®¾ç½®æƒé‡ï¼ˆ0.0-1.0ï¼‰

3. **`download_scripts/download_CSL_News.py`**
   - ç¬¬51è¡Œï¼šä¿®å¤poseæ•°æ®è§£å‹è·¯å¾„bugï¼ˆå·²ä¿®å¤ï¼‰

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å‰ç½®æ¡ä»¶

1. **å®ŒæˆStage 1é¢„è®­ç»ƒ**ï¼š
   ```bash
   ./script/train_stage1.sh
   ```
   ç¡®ä¿ç”Ÿæˆäº† `out/stage1_pretraining/best_checkpoint.pth`

2. **å‡†å¤‡CSL_Dailyæ•°æ®é›†**ï¼š
   - CSL_Dailyæ˜¯å”¯ä¸€åŒ…å«glossæ ‡æ³¨çš„æ•°æ®é›†
   - ç¡®ä¿ä»¥ä¸‹è·¯å¾„å­˜åœ¨ï¼š
     - `./dataset/CSL_Daily/pose_format/*.pkl`
     - `./dataset/CSL_Daily/sentence-crop/*.mp4`
     - `./dataset/CSL_Daily/label/train.json`

### è®­ç»ƒå‘½ä»¤

#### 1. åŸºçº¿å®éªŒï¼ˆä¸ä½¿ç”¨åŒˆç‰™åˆ©æŸå¤±ï¼‰
```bash
./script/train_cslr_baseline.sh
```
- è¾“å‡ºç›®å½•ï¼š`out/cslr_baseline/`
- æŸå¤±å‡½æ•°ï¼šçº¯äº¤å‰ç†µæŸå¤±
- ç”¨äºå¯¹æ¯”baselineæ€§èƒ½

#### 2. è½»é‡åŒˆç‰™åˆ©æŸå¤±ï¼ˆæ¨èå…ˆå°è¯•ï¼‰
```bash
./script/train_cslr_hungarian_0.3.sh
```
- è¾“å‡ºç›®å½•ï¼š`out/cslr_hungarian_0.3/`
- æŸå¤±å‡½æ•°ï¼š`0.7 * CE_loss + 0.3 * Hungarian_loss`
- é€‚åˆåˆæ­¥éªŒè¯åŒˆç‰™åˆ©æŸå¤±æ•ˆæœ

#### 3. å¹³è¡¡åŒˆç‰™åˆ©æŸå¤±
```bash
./script/train_cslr_hungarian_0.5.sh
```
- è¾“å‡ºç›®å½•ï¼š`out/cslr_hungarian_0.5/`
- æŸå¤±å‡½æ•°ï¼š`0.5 * CE_loss + 0.5 * Hungarian_loss`
- CEæŸå¤±å’ŒåŒˆç‰™åˆ©æŸå¤±å„å ä¸€åŠ

#### 4. é‡é‡åŒˆç‰™åˆ©æŸå¤±
```bash
./script/train_cslr_hungarian_0.7.sh
```
- è¾“å‡ºç›®å½•ï¼š`out/cslr_hungarian_0.7/`
- æŸå¤±å‡½æ•°ï¼š`0.3 * CE_loss + 0.7 * Hungarian_loss`
- æ›´å¼ºè°ƒæ— åºåŒ¹é…

### è‡ªå®šä¹‰è®­ç»ƒ

å¦‚æœæƒ³è‡ªå®šä¹‰æƒé‡ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œï¼š

```bash
deepspeed --include localhost:0,1,2,3 --master_port 29511 fine_tuning.py \
  --batch-size 8 \
  --gradient-accumulation-steps 1 \
  --epochs 20 \
  --opt AdamW \
  --lr 3e-4 \
  --output_dir out/cslr_custom \
  --finetune out/stage1_pretraining/best_checkpoint.pth \
  --dataset CSL_Daily \
  --task CSLR \
  --label_smoothing 0.2 \
  --use_hungarian \
  --hungarian_weight 0.4  # è‡ªå®šä¹‰æƒé‡
```

---

## ğŸ“Š å®éªŒå»ºè®®

### å¯¹æ¯”å®éªŒè®¾è®¡

| å®éªŒç»„ | è„šæœ¬ | Hungarianæƒé‡ | é¢„æœŸæ•ˆæœ |
|--------|------|--------------|---------|
| Baseline | `train_cslr_baseline.sh` | 0.0 | åŸºçº¿æ€§èƒ½ |
| Light | `train_cslr_hungarian_0.3.sh` | 0.3 | è½»å¾®æ”¹å–„é¡ºåºåå·® |
| Medium | `train_cslr_hungarian_0.5.sh` | 0.5 | å¹³è¡¡é¡ºåºå’Œå†…å®¹ |
| Heavy | `train_cslr_hungarian_0.7.sh` | 0.7 | å¼ºè°ƒå†…å®¹åŒ¹é… |

### è¯„ä¼°æŒ‡æ ‡

è®­ç»ƒè¿‡ç¨‹ä¼šè‡ªåŠ¨è®°å½•ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **WERï¼ˆWord Error Rateï¼‰** - ä¸»è¦æŒ‡æ ‡ï¼Œè¶Šä½è¶Šå¥½
   - è®¡ç®—å…¬å¼ï¼š`WER = (æ’å…¥ + åˆ é™¤ + æ›¿æ¢) / å‚è€ƒåºåˆ—é•¿åº¦ Ã— 100%`

2. **Del Rate** - åˆ é™¤ç‡
3. **Ins Rate** - æ’å…¥ç‡
4. **Sub Rate** - æ›¿æ¢ç‡

æŸ¥çœ‹ç»“æœï¼š
```bash
# æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
tail -f out/cslr_hungarian_0.5/log.txt

# æŸ¥çœ‹æœ€ä½³æ¨¡å‹
ls out/cslr_hungarian_0.5/best_checkpoint.pth
```

### é¢„æœŸç»“æœ

**ä¼˜ç‚¹ï¼š**
- WERå¯èƒ½é™ä½2-5%ï¼ˆå–å†³äºæ•°æ®é›†ä¸­é¡ºåºä¸ä¸€è‡´çš„ç¨‹åº¦ï¼‰
- å¯¹glossé¡ºåºå˜åŒ–æ›´é²æ£’
- å‡å°‘å› æ ‡æ³¨é¡ºåºä¸ä¸€è‡´å¯¼è‡´çš„é”™è¯¯

**æ½œåœ¨é—®é¢˜ï¼š**
- è®­ç»ƒé€Ÿåº¦ç•¥æ…¢ï¼ˆåŒˆç‰™åˆ©ç®—æ³•O(nÂ³)å¤æ‚åº¦ï¼‰
- å¦‚æœglossé¡ºåºæœ¬èº«å¾ˆé‡è¦ï¼Œå¯èƒ½æŸå¤±éƒ¨åˆ†é¡ºåºä¿¡æ¯
- éœ€è¦è°ƒæ•´è¶…å‚æ•°æ‰¾åˆ°æœ€ä¼˜æƒé‡

---

## ğŸ” è°ƒè¯•ä¸ç›‘æ§

### æŸ¥çœ‹æŸå¤±åˆ†é‡

è®­ç»ƒæ—¶ä¼šæ‰“å°ä¸¤ä¸ªæŸå¤±å€¼ï¼ˆå¦‚æœå¯ç”¨äº†åŒˆç‰™åˆ©æŸå¤±ï¼‰ï¼š

```
loss_ce: 2.345          # äº¤å‰ç†µæŸå¤±
loss_hungarian: 1.987   # åŒˆç‰™åˆ©æŸå¤±
total_loss: 2.166       # åŠ æƒæ€»æŸå¤±
```

### å¸¸è§é—®é¢˜æ’æŸ¥

#### 1. å¯¼å…¥é”™è¯¯
```
ModuleNotFoundError: No module named 'hungarian_loss'
```
**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿ `hungarian_loss.py` åœ¨é¡¹ç›®æ ¹ç›®å½•

#### 2. scipyæœªå®‰è£…
```
ModuleNotFoundError: No module named 'scipy'
```
**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
pip install scipy
```

#### 3. å†…å­˜ä¸è¶³
åŒˆç‰™åˆ©ç®—æ³•éœ€è¦é¢å¤–å†…å­˜ã€‚å¦‚æœé‡åˆ°OOMï¼š
- å‡å°batch sizeï¼š`--batch-size 4`
- æˆ–å‡å°hungarian_weightï¼š`--hungarian_weight 0.3`

#### 4. è®­ç»ƒé€Ÿåº¦æ…¢
åŒˆç‰™åˆ©ç®—æ³•ä¼šå¢åŠ çº¦10-15%çš„è®­ç»ƒæ—¶é—´ã€‚å¦‚æœå¤ªæ…¢ï¼š
- ä½¿ç”¨æ›´å°çš„æƒé‡ï¼ˆ0.3è€Œä¸æ˜¯0.7ï¼‰
- æˆ–åœ¨åˆæœŸä½¿ç”¨baselineè®­ç»ƒï¼ŒåæœŸå¯ç”¨åŒˆç‰™åˆ©æŸå¤±

---

## ğŸ“ˆ ç»“æœåˆ†æ

### å¯¹æ¯”baseline

è®­ç»ƒå®Œæˆåï¼Œå¯¹æ¯”ä¸åŒé…ç½®çš„WERï¼š

```bash
# æå–å„ä¸ªå®éªŒçš„æœ€ä½³WER
grep "Min WER" out/cslr_baseline/log.txt
grep "Min WER" out/cslr_hungarian_0.3/log.txt
grep "Min WER" out/cslr_hungarian_0.5/log.txt
grep "Min WER" out/cslr_hungarian_0.7/log.txt
```

### ç”Ÿæˆå¯¹æ¯”è¡¨æ ¼

| é…ç½® | æœ€ä½³WER | Del% | Ins% | Sub% | å¤‡æ³¨ |
|------|---------|------|------|------|------|
| Baseline | XX.XX% | X.X% | X.X% | X.X% | æ ‡å‡†CEæŸå¤± |
| Hungarian-0.3 | XX.XX% | X.X% | X.X% | X.X% | è½»é‡ç‰ˆ |
| Hungarian-0.5 | XX.XX% | X.X% | X.X% | X.X% | å¹³è¡¡ç‰ˆ |
| Hungarian-0.7 | XX.XX% | X.X% | X.X% | X.X% | é‡é‡ç‰ˆ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

å¦‚æœåŒˆç‰™åˆ©æŸå¤±æ•ˆæœå¥½ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **åŠ¨æ€æƒé‡è°ƒæ•´**ï¼š
   - å‰æœŸä½¿ç”¨é«˜CEæƒé‡ï¼ˆ0.8ï¼‰ï¼Œå­¦ä¹ åŸºæœ¬åºåˆ—æ¨¡å¼
   - åæœŸå¢åŠ Hungarianæƒé‡ï¼ˆ0.5ï¼‰ï¼Œä¼˜åŒ–glossåŒ¹é…

2. **ç»“åˆCTC Loss**ï¼š
   - CTCä¸“é—¨å¤„ç†åºåˆ—å¯¹é½é—®é¢˜
   - å¯ä»¥ä¸‰è€…ç»“åˆï¼š`Î±*CE + Î²*Hungarian + Î³*CTC`

3. **Glossçº§åˆ«çš„æ³¨æ„åŠ›æœºåˆ¶**ï¼š
   - åœ¨è§£ç å™¨ä¸­åŠ å…¥gloss-aware attention
   - å¸®åŠ©æ¨¡å‹æ›´å¥½åœ°æ•æ‰glossä¹‹é—´çš„å…³ç³»

4. **æ•°æ®å¢å¼º**ï¼š
   - éšæœºæ‰“ä¹±glossé¡ºåºè¿›è¡Œè®­ç»ƒ
   - å¢å¼ºæ¨¡å‹å¯¹é¡ºåºå˜åŒ–çš„é²æ£’æ€§

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### åŒˆç‰™åˆ©ç®—æ³•å®ç°

ä½¿ç”¨ `scipy.optimize.linear_sum_assignment` æ±‚è§£æœ€ä¼˜åŒ¹é…ï¼š

```python
# æˆæœ¬çŸ©é˜µ: (L, T)
# L = é¢„æµ‹åºåˆ—é•¿åº¦, T = ç›®æ ‡åºåˆ—é•¿åº¦
cost_matrix[i, j] = -log P(target_j | prediction_i)

# æ±‚è§£æœ€ä¼˜åˆ†é…
src_idx, tgt_idx = linear_sum_assignment(cost_matrix)
```

### æŸå¤±è®¡ç®—æµç¨‹

```
1. å‰å‘ä¼ æ’­ â†’ è·å¾— logits (B, L, V)
2. å¯¹æ¯ä¸ªæ ·æœ¬ï¼š
   a. è®¡ç®—æˆæœ¬çŸ©é˜µ (L, T)
   b. åŒˆç‰™åˆ©ç®—æ³•æ±‚è§£æœ€ä¼˜åŒ¹é…
   c. æ ¹æ®åŒ¹é…å¯¹è®¡ç®—äº¤å‰ç†µ
3. æ±‡æ€»æ‰€æœ‰æ ·æœ¬çš„æŸå¤±
4. ä¸æ ‡å‡†CEæŸå¤±åŠ æƒç»„åˆ
```

---

## ğŸ“ è”ç³»ä¸åé¦ˆ

å¦‚æœé‡åˆ°é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼š
- æ£€æŸ¥ `out/*/log.txt` ä¸­çš„é”™è¯¯ä¿¡æ¯
- ç¡®ä¿CSL_Dailyæ•°æ®é›†å®Œæ•´ä¸‹è½½
- éªŒè¯Stage 1æ¨¡å‹å·²æˆåŠŸè®­ç»ƒ

---

## ğŸ“„ å‚è€ƒæ–‡çŒ®

- **DETR**: End-to-End Object Detection with Transformers (åŒˆç‰™åˆ©æŸå¤±çš„ç»å…¸åº”ç”¨)
- **Hungarian Algorithm**: æœ€ä¼˜äºŒåˆ†å›¾åŒ¹é…ç®—æ³•
- **CSLR**: Continuous Sign Language Recognitionç»¼è¿°

---

**ç¥å®éªŒé¡ºåˆ©ï¼ğŸ‰**
